# 飞书应用配置说明

## 如何获取飞书应用凭证

1. **登录飞书开放平台**
   - 访问 https://open.feishu.cn/
   - 使用飞书账号登录

2. **创建应用**
   - 进入"应用管理"
   - 点击"创建企业自建应用"
   - 输入应用名称，例如"股票分析充值审核"
   - 创建成功后，进入应用详情页

3. **获取 App ID 和 App Secret**
   - 在应用详情页的"凭证与基础信息"中
   - 复制 `App ID` 和 `App Secret`
   - 将这两个值添加到 `.env.local` 文件中

4. **配置应用权限**
   - 进入"权限管理"
   - 搜索并添加以下权限：
     - `im:message` - 发送消息权限
     - `im:message.group_at_msg` - 群组消息权限

5. **创建 Webhook（可选）**
   - 如果要在飞书群中使用机器人通知
   - 可以在群设置中添加自定义机器人
   - 复制 Webhook URL

6. **获取管理员 OpenID（可选）**
   - 如果需要给特定管理员发送通知
   - 可以使用飞书开放平台的 API 获取用户的 OpenID

## 环境变量配置

在 `.env.local` 文件中添加以下配置：

```bash
# 飞书应用配置
FEISHU_APP_ID=your_app_id_here
FEISHU_APP_SECRET=your_app_secret_here
FEISHU_WEBHOOK_URL=your_webhook_url_here  # 可选
FEISHU_ADMIN_OPEN_ID=admin_open_id_here   # 可选
```

## 使用方式

### 方式一：使用 Webhook（推荐）
1. 配置 `FEISHU_WEBHOOK_URL`
2. 用户提交充值请求后，会自动发送消息到飞书群
3. 管理员点击消息中的"前往审核"按钮
4. 跳转到管理后台进行审核操作

### 方式二：使用管理后台
1. 直接访问 `/admin/topup` 页面
2. 查看所有待审核的充值请求
3. 点击"通过"或"拒绝"按钮进行操作

## 审核流程

1. 用户在前端提交充值请求
2. 系统创建充值记录（状态：pending）
3. 发送通知到飞书（如果配置了 Webhook）
4. 管理员在飞书中查看消息
5. 管理员点击"前往审核"或直接访问管理后台
6. 管理员进行审核操作
7. 审核通过后，自动增加用户积分
8. 审核拒绝后，记录拒绝原因

## 安全建议

1. **限制管理员访问**
   - 管理后台应该增加权限验证
   - 可以通过数据库中的 `role` 字段区分管理员和普通用户

2. **API 鉴权**
   - 所有管理员 API 都需要验证 JWT token
   - 确保只有授权用户可以访问

3. **操作日志**
   - 记录所有审核操作
   - 包括审核人、审核时间、审核结果等

## 后续优化

1. **实现飞书交互式卡片**
   - 配置飞书应用的回调 URL
   - 在飞书卡片中直接进行审核操作

2. **添加短信/邮件通知**
   - 审核通过后通知用户

3. **增加统计报表**
   - 充值金额统计
   - 审核效率统计
   - 用户充值行为分析
