# 数据统计功能使用说明

## 功能概述

股票智能分析工具现已集成数据统计功能，可以实时跟踪和分析使用数据、积分消耗等信息。

## 主要功能

### 1. 数据统计面板
访问 `/stats` 页面查看以下统计数据：

#### 概览指标
- **总分析次数**：累计完成的股票分析次数
- **分析股票数**：累计分析的股票总数
- **积分消耗**：累计消耗的Token数量（以"积分"形式展示）
- **平均耗时**：每次分析的平均时长（秒）

#### 图表展示
- **分析趋势图**：显示最近N天的分析次数和股票数量趋势
- **积分消耗趋势图**：显示最近N天的Token消耗趋势

#### 历史记录
- **最近分析记录**：显示最新的10次分析记录，包括：
  - 文件名
  - 股票数量
  - 搜索次数
  - Token消耗
  - 分析耗时
  - 分析时间

### 2. 时间范围筛选
支持选择不同时间范围查看统计数据：
- 7天
- 30天
- 90天

### 3. 实时刷新
点击"刷新"按钮可以获取最新的统计数据。

## 数据收集说明

### 自动收集的数据
每次股票分析时，系统会自动记录以下信息：

1. **文件信息**
   - 文件名

2. **股票数据**
   - 分析的股票数量

3. **搜索数据**
   - 总搜索次数（每个维度搜索计为1次）
   - 共11个搜索维度

4. **AI调用数据**
   - Token消耗量（包括输入Token和输出Token）
   - 基于DeepSeek V3.2模型

5. **性能数据**
   - 分析总时长（秒）

### 统计计算方式

#### Token消耗估算
```typescript
输入Token = JSON.stringify(messages).length / 4
输出Token = response.content.length / 4
总Token = 输入Token + 输出Token
```

#### 搜索次数统计
- 每个股票进行11个维度的搜索
- 每个维度搜索计为1次
- 总搜索次数 = 股票数量 × 11

#### 分析时长
从开始分析到完成分析的总时间（秒）

## 数据库说明

### 数据库表结构

#### statistics 表
存储每次分析的详细数据：
```sql
- id: 主键
- fileName: 文件名
- stockCount: 股票数量
- totalSearchCount: 总搜索次数
- totalTokens: 总Token消耗
- analysisDuration: 分析时长
- createdAt: 创建时间
```

#### usage_summary 表
存储每日使用汇总数据：
```sql
- id: 主键
- date: 日期（YYYY-MM-DD）
- totalAnalyses: 当天总分析次数
- totalStocks: 当天总股票数
- totalTokens: 当天总Token消耗
- createdAt: 创建时间
```

## 使用流程

### 1. 初始化数据库（首次使用）
```bash
# 生成数据库迁移文件
pnpm db:generate

# 执行数据库迁移
pnpm db:migrate
```

### 2. 使用分析功能
正常使用股票分析功能，系统会自动记录统计数据。

### 3. 查看统计数据
1. 在主页点击"数据统计"按钮
2. 或直接访问 `/stats` 页面
3. 选择要查看的时间范围
4. 查看各项统计指标和图表

## API接口

### 获取统计数据
```
GET /api/stats?days=7
```

参数：
- days: 天数（可选，默认7）

返回：
```json
{
  "overview": {
    "totalAnalyses": 100,
    "totalStocks": 500,
    "totalTokens": 1000000,
    "avgDuration": 45
  },
  "dailyStats": [...],
  "recentAnalyses": [...],
  "tokenTrend": [...]
}
```

### 记录统计数据
```
POST /api/stats/record
```

请求体：
```json
{
  "fileName": "test.xlsx",
  "stockCount": 10,
  "totalSearchCount": 110,
  "totalTokens": 50000,
  "analysisDuration": 120
}
```

## 注意事项

1. **数据库依赖**
   - 需要配置PostgreSQL数据库
   - 需要设置环境变量 `DATABASE_URL`

2. **性能影响**
   - 统计记录是异步执行的，不影响主分析流程
   - 如果数据库不可用，统计记录失败不会中断分析

3. **数据准确性**
   - Token消耗为估算值，仅供参考
   - 搜索次数按维度计数，不是实际API调用次数

4. **隐私保护**
   - 仅记录统计数据，不存储具体的股票分析内容
   - 文件名可能是用户上传的原始文件名

## 配置要求

### 环境变量
```env
DATABASE_URL=postgresql://user:password@host:port/database
```

### 数据库权限
需要确保数据库用户具有以下权限：
- CREATE TABLE
- INSERT
- SELECT
- UPDATE

## 故障排查

### 统计数据无法显示
1. 检查数据库连接是否正常
2. 检查环境变量 `DATABASE_URL` 是否配置
3. 查看后端日志是否有错误信息

### 统计数据不准确
1. 检查分析流程是否正常完成
2. 查看后端日志确认统计记录是否成功
3. 检查数据库表是否有数据

## 未来改进方向

1. 增加更多统计维度（如平均每只股票的Token消耗）
2. 添加数据导出功能（导出为CSV或Excel）
3. 增加用户级别统计（如果有多用户系统）
4. 添加成本预估功能（基于Token消耗计算费用）
5. 增加数据可视化（更多图表类型）
