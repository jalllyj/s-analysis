# 积分系统和配额规则

## 概述

股票智能分析工具采用**免费额度 + 积分**的双重配额机制，确保每个用户都能享受基础服务，同时为高级用户提供更多分析次数。

## 收费规则

### 免费额度
- **所有用户**每月享有 **5次**免费分析额度
- 免费额度在每月1日自动重置
- 免费额度优先使用

### 积分系统
- **付费套餐**用户每月获得赠送积分
- **1积分 = 1只股票**的分析消耗
- 积分可以累积，不会过期
- 企业版用户享有无限积分

## 套餐对比

| 套餐 | 价格 | 免费额度 | 月赠积分 | 总分析能力 |
|------|------|----------|----------|------------|
| 免费版 | ¥0 | 5次 | 0积分 | 5只股票/月 |
| 基础版 | ¥29/月 | 5次 | 50积分 | 55只股票/月 |
| 专业版 | ¥99/月 | 5次 | 500积分 | 505只股票/月 |
| 企业版 | ¥299/月 | 5次 | 无限 | 无限 |

## 使用规则

### 优先级
1. **第一优先**：使用每月免费额度
2. **第二优先**：使用积分余额
3. **无额度**：升级套餐或等待下月重置

### 使用示例

#### 场景1：免费版用户
- 分析3只股票 → 消耗3次免费额度
- 分析5只股票 → 消耗5次免费额度（本月额度用完）
- 分析第6只股票 → 提示升级套餐

#### 场景2：基础版用户
- 分析3只股票 → 消耗3次免费额度
- 分析10只股票 → 消耗5次免费额度 + 5积分
- 分析60只股票 → 消耗5次免费额度 + 55积分

#### 场景3：专业版用户
- 分析100只股票 → 消耗5次免费额度 + 95积分
- 分析600只股票 → 消耗5次免费额度 + 495积分
- 下月1日 → 免费额度重置，积分继续累积

## 积分获取

### 订阅赠送
- 基础版：每月赠送 50 积分
- 专业版：每月赠送 500 积分
- 企业版：无限积分

### 积分特性
- ✅ 积分可以累积，不会过期
- ✅ 积分在所有付费套餐中通用
- ✅ 取消订阅不影响已有积分
- ✅ 升级套餐可一次性获得对应积分

## 配额检查逻辑

```
检查配额 (用户ID, 股票数量)
  ↓
获取当前活跃订阅
  ↓
计算本月免费额度使用情况
  ↓
如果免费额度足够 → 允许分析
  ↓
如果免费额度不足
  ↓
检查积分余额
  ↓
如果积分足够 → 允许分析（消耗积分）
  ↓
如果积分也不够 → 拒绝分析，提示升级
```

## 使用记录

系统会记录每次分析的详细信息：

```typescript
{
  stocksAnalyzed: 10,        // 分析的股票总数
  usedFreeQuota: 5,         // 使用的免费额度
  creditsUsed: 5,           // 使用的积分
  usedAt: timestamp         // 使用时间
}
```

## 积分交易记录

每次积分变动都会记录：

```typescript
{
  amount: -5,              // 积分变动数量（负数为消耗）
  balance: 95,             // 变动后余额
  type: 'consume',         // 类型：grant/consume/refund
  description: '分析10只股票',
  createdAt: timestamp
}
```

## API 示例

### 检查配额

```typescript
const quotaCheck = await checkUserQuota(userId, stocksCount);

if (quotaCheck.allowed) {
  console.log('允许分析');
  console.log('消耗:', quotaCheck.message);
} else {
  console.log('配额不足:', quotaCheck.message);
}
```

### 记录使用

```typescript
await recordUsage(userId, subscriptionId, stocksCount);
// 自动处理免费额度和积分消耗
```

## 常见问题

### Q1: 积分会过期吗？
A: 不会。积分永久有效，可以累积使用。

### Q2: 免费额度什么时候重置？
A: 每月1日凌晨自动重置为5次。

### Q3: 降级套餐后积分会减少吗？
A: 不会。已有积分会保留，但无法再获得新积分。

### Q4: 超出配额后怎么办？
A: 两个选择：
1. 升级套餐获得更多积分
2. 等待下月1日免费额度重置

### Q5: 企业版用户真的无限吗？
A: 是的。企业版用户享有无限积分，可以分析任意数量的股票。

## 费用说明

### 积分成本
- 基础版：每积分 = ¥0.58（50积分/¥29）
- 专业版：每积分 = ¥0.198（500积分/¥99）
- 企业版：¥0/积分（无限）

### 性价比
| 套餐 | 单只股票成本 | 性价比 |
|------|-------------|--------|
| 免费版 | ¥0 | 基础服务 |
| 基础版 | ¥0.58 | 适合轻量使用 |
| 专业版 | ¥0.198 | **性价比最高** |
| 企业版 | ¥0 | 适合机构 |

## 最佳实践

### 对于个人投资者
- **推荐套餐**：专业版（¥99/月）
- **月分析能力**：505只股票
- **适合场景**：每日关注100+只股票，深度分析

### 对于团队/机构
- **推荐套餐**：企业版（¥299/月）
- **月分析能力**：无限
- **适合场景**：高频分析、批量处理、API集成

## 总结

- ✅ 所有用户享有每月5次免费分析
- ✅ 付费套餐获得积分，可抵消分析消耗
- ✅ 免费额度优先使用，积分作为补充
- ✅ 积分可累积，不设有效期
- ✅ 企业版享有无限积分
- ✅ 专业版性价比最高（每只股票仅¥0.198）

## 技术实现

相关文件：
- 数据库模型：`src/lib/db/schema.ts`
- 积分管理：`src/lib/quota.ts`
- 定价配置：`src/lib/pricing.ts`
- 用户订阅API：`src/app/api/user/subscription/route.ts`
- 分析API：`src/app/api/analyze/route.ts`
